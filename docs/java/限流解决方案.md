# 熔断限流解决方案

## 问题

1. 前端热部署，修改代码，导致突然同时点播多条视频监控，导致服务崩溃。
2. 外部平台异常批量调用接口，导致服务崩溃。

## 什么是限流


### 熔断

#### 概念：
    熔断是一种用于处理分布式系统中服务故障的机制。它就像电路中的保险丝，当服务出现故障或者响应时间过长等异常情况时，为了防止故障的扩散和系统资源的过度消耗，熔断器会 “切断” 服务调用链路，直接返回预设的错误信息，而不是让请求一直等待或者不断重试导致系统崩溃。
#### 工作原理

    1. 闭合状态（Closed）：在正常情况下，熔断器处于闭合状态，服务请求可以正常通过熔断器到达后端服务。此时，熔断器会记录服务调用的成功次数、失败次数、响应时间等指标。
    2. 打开状态（Open）：当服务的失败率达到一定的阈值（例如，在一定时间内，失败次数占总请求次数的比例超过 50%）或者响应时间超过设定的最大值时，熔断器会从闭合状态转换为打开状态。在打开状态下，后续的服务请求不会被发送到后端故障服务，而是直接返回一个预设的错误响应，如 “服务暂时不可用”，这样可以快速地让客户端知道服务出现问题，避免客户端长时间等待。
    3. 半开状态（Half - Open）：经过一段时间后（这个时间也是可以设置的，称为熔断时间窗），熔断器会进入半开状态。在半开状态下，允许少量的请求通过熔断器去尝试调用后端服务，以检查服务是否已经恢复正常。如果这些请求成功，熔断器会认为服务已经恢复，然后转换回闭合状态；如果这些请求仍然失败，熔断器会再次打开，继续等待下一个时间窗再进行尝试。

### 限流

#### 概念：
    限流是一种用于控制进入系统的流量（如请求数量、数据量等）的技术。它的目的是保护系统免受过多请求的冲击，确保系统在其处理能力范围内稳定运行，防止系统因为过载而崩溃或者性能下降。
#### 工作原理

    1. 计数器算法：这是一种简单的限流算法。例如，设定一个时间窗口（如 1 秒）和一个最大请求次数（如 100 次）。使用一个计数器来记录在这个时间窗口内已经处理的请求数量。当有请求进入时，先检查计数器的值。如果计数器小于最大请求次数，请求被允许通过，并且计数器加 1；如果计数器已经达到最大请求次数，那么新的请求就会被拒绝或者放入等待队列（如果有等待队列机制）。当时间窗口结束后，计数器清零，开始下一个时间窗口的计数。
    2. 令牌桶算法：令牌桶算法中有一个令牌桶，它以一个固定的速率（如每秒生成 10 个令牌）生成令牌，令牌桶有一个固定的容量（如最多容纳 100 个令牌）。当请求进入系统时，需要从令牌桶中获取一个令牌，如果令牌桶中有足够的令牌，请求就可以通过，同时令牌桶中的令牌数量减 1；如果令牌桶中没有令牌了，请求就会被拒绝或者放入等待队列。这种算法可以应对突发流量，因为令牌桶在空闲时可以积累令牌，当突发流量来临时，只要令牌桶中有足够的令牌，请求就可以通过。
    3. 漏桶算法：漏桶算法类似于一个底部有漏洞的水桶，请求像水一样流入水桶。水桶以一个固定的速率（如每秒流出 5 个请求）将请求 “漏出”，也就是处理请求。如果流入的请求速度超过了流出的速度，水桶就会装满，多余的请求就会被丢弃。这种算法可以平滑流量，使得请求以一个稳定的速率被处理。
## 解决方案

    1. Hystrix：Netflix 开源的一个限流、熔断和降级库，已停止维护。在微服务架构兴起的过程中发挥了重要作用，通过隔离、熔断、降级等策略来防止服务雪崩。
    2. Sentinel：由阿里巴巴开源的一款面向分布式服务架构的轻量级流量控制和熔断降级框架。它主要用于保障服务的稳定性，涵盖了限流、熔断、降级等多种功能，并且提供了实时的监控和动态配置功能。
    2. Resilience4j：一个轻量级的 Java 库，与 Spring Boot 集成方便，利用注解（如@CircuitBreaker、@RateLimiter等）就能在服务方法中应用容错功能，便于在现有项目中快速引入。轻量级设计,函数式编程风格,灵活配置。