#后端开发参考规范

---

## 1. **数据库设计规范**

### 1.1 表结构设计

- **表命名**：  

  - 使用小写字母和下划线组合，如 `fk_user_info`。  

  - 统一携带项目缩写，例如智慧小区， `wc_sys_user_info`、`wc_sys_user_role`。    

- **字段**：  

  - 使用下划线命名法（如 `user_id`），避免使用保留关键字。  

  - 常见字段统一命名（如 `create_time`, `update_time`,`create_user_id`, `update_user_id`）。  

  - 定长字符串使用`char`

  - 布尔使用`bit`

  - 日期使用

- **主键设计**：  

  - 主键推荐使用 `bigint` 类型，命名如 `id`。  

  - 不得使用业务字段（如手机号、警号）作为主键。  

- **索引规范**：  

  - 高频查询字段需加索引（如 `user_id`, `order_no`）。  

  - 联合索引需按字段查询频率排序，避免冗余索引。  

  - 单表索引数量建议不超过5个

- **约束规范**：  

  - 非空字段加 `NOT NULL` 约束。  

- **字符集规范**：  

  - 所有表统一字符集，例如字符串统一使用 `utf8_bin`

### 1.2 查询规范

- 使用pagehelp分页查询时，针对一些复杂的查询，可以重写其统计方法（例如查询方法为selectUser,则可自定义selectuser_COUNT方法统计数量）

---

## 2. **代码规范**

### 2.1 命名规范

- **类名**：大驼峰命名法（如 `UserService`）。  

- **方法名**：小驼峰命名法（如 `getUserById`）。  

- **变量名**：小驼峰命名法（如 `userName`）。  

- **常量名**：全大写加下划线（如 `MAX_RETRY_COUNT`）。 

- **包名**：使用全小写字母，单词间用点号分隔，（如 `com.geshu.wc`）。 

---

### 2.2  注释规范

  - 类：在类定义前添加注释，说明类的功能、作者、创建时间等信息。

  ```java

  /**

    * @author: byh

    * @create: 2023/3/13

    * @Description: 登录控制器

    * @ClassName: LoginController

    */

    public class LoginController{

    }

  ```

  - 方法：使用Javadoc 注释，说明功能、参数和返回值。  

  ```java

  /**

     * 设置有效时间

     *

     * @param key     Redis键

     * @param timeout 超时时间

     * @param unit    时间单位

     * @return true=设置成功；false=设置失败

     */

    public boolean expire(final String key, final long timeout, final TimeUnit unit) {

        return redisTemplate.expire(key, timeout, unit);

    }

  ```

  - 行：复杂逻辑需添加行注释，解释实现细节。  

  ```java

        // 中途上线的设备 需要删除

        List<CmsRepairOrder> cmsRepairOrders1 = new ArrayList<>();

        // 新增设备维修单

        List<CmsRepairOrder> cmsRepairOrders2 = new ArrayList<>();

  ```

---

### 2.3  枚举

-对于状态、类型等不得直接使用字符串

``` java

public enum RoleEnum {

    REPAIRER("REPAIRER","维修员"),

    OUT_REPAIRER("OUT_REPAIRER","外部维修员"),

    VISITOR("VISITOR","游客"),

    ADMIN("ADMIN","管理员"),

    ;

    //省略方法

}

//if(req.getUserRole.equals("REPAIRER")) 

if(req.getUserRole.equals(RoleEnum.REPAIRER.getCode())) {

    ...

}

```

### 2.4 日志

- 接口请求使用统一注解实现日志记录

```java

    @Log(name = "获取登录日志", module = "日志管理",isSaveLog = false,isSaveRequestData = false)

    public AjaxResult<PageInfo<ResLoginLogVo>> getLoginLog(@RequestBody ReqGetLoginLogVo reqVo){

        return sysLogService.getLoginLog(reqVo);

    }

```

- 禁止使用sout打印日志

- 开发环境调试可以使用`DEBUG`。  

- 关键业务流程日志（如开启定时任务）使用`INFO`。    

- 系统错误（如数据库连接失败、空指针异常）使用`ERROR`。  

### 2.4.5 异常

- 禁止使用e.printStackTrace()等打印日志

- 对于定时任务、异步任务必须进行异常捕获，和错误日志的记录

```java

@Component

@Slf4j

public class DeleteYoungJob implements BaseTask {

    @Override

    public void run() {

        

         try {

            log.info("开始删除未成年人库已成年的人员{}",DateUtil.date());

            //逻辑处理

            //...

        } catch (Exception e) {

            log.error("执行删除未成年人库已成年的人员任务时发生异常",e);

        }

    }

}

```

- 对于http请求发生RPC的错误，抛出同一类型异常，全局异常捕获时进行统一处理返回

```java

    public <O> O sendPost(...) {

        try {

            //发起中转平台post请求

            response = HttpRequest.post(url).body(reqData).execute();

            //判断是否调用成功

            if(response.getStatus()==200){

                if(ObjectUtil.isNotEmpty(resAccessTokenCommResponse) && resAccessTokenCommResponse.isSuccess()){

                    O resData = resAccessTokenCommResponse.getData();

                    return resData;

                }else {

                    //业务异常

                    String errorMessage= resAccessTokenCommResponse.getCode()+resAccessTokenCommResponse.getMessage();

                    throw new MyThrowException(RespCodeEnum.RPC_FAIL.getCode(),"调用中转平台接口业务异常:"+errorMessage);

                }

            }else {

                //调用失败异常

                throw new MyThrowException(RespCodeEnum.RPC_FAIL.getCode(),"调用中转平台接口异常:"+response.getStatus());

            }

        } catch (MyThrowException e){

            //已知类型异常，打印后 都抛出同类型异常

            logger.error("发起中转平台请求发生异常",e);

            throw new MyRPCException("中转");

        } catch (Exception e) {

            //未知异常，打印后 都抛出同类型异常

            logger.error("发起中转平台请求发生未知异常",e);

            throw new MyRPCException("中转");

        }

    }

    /**

     * 全局RPC异常捕获处理

     */

    @ExceptionHandler(MyRPCException.class)

    public AjaxResult handleServiceException(MyRPCException e, HttpServletRequest request) {

        String code = e.getErrorCode();

        log.error("调用{}平台发生异常",code);

        return AjaxResult.error("系统异常");

    }

```

- 明确的错误，可以抛出指定类型异常,全局异常时会进行统一处理

```java

    

    if(name.length()>10){

        //姓名超过10位

        //抛出异常

        throw new MyThrowException("姓名不能超过10位")

        //或者直接返回

        //AjaxResult.error("姓名不能超过10位");

    }

    /**

     * 全局业务异常捕获处理

     */

    @ExceptionHandler(MyThrowException.class)

    public AjaxResult handleServiceException(MyThrowException e, HttpServletRequest request) {

        return AjaxResult.error(e.getErrorCode(),e.getMessage());

    }

```

---

## 请求规范

### 请求参数

- 分页请求body必须继承同一个的分页父类，保证分页参数（pageSize,pageNo）统一
- 对于增删改的请求body参数需要加入注释（`@ApiModelProperty`）、以及一些简单的校验(`@NotBlank`、`@Max`、`@Min`等)

```java

public class AddUserVo{

    /**

     * 人员身份证

        */

    @ApiModelProperty(value = "人员身份证")

    @NotBlank

    private String personIdCode;

}

```
### 返回参数
- 统一返回样式
```java
	//成功
	return AjaxResult.success("成功数据");
	//失败
	return AjaxResult.error("错误码","错误描述")
```
- 不得返回Map类型数据
- 对于时间类型，必须返回时间戳格式

- 对于id为LONG型时，需要进行转换字符串进行返回

```java

    res.setId(String.valueOf(wuPoliceInfo.getId()));

    if(ObjectUtil.isNotNull(wuPoliceInfo.getCreateTime())){

     res.setCreateTime(wuPoliceInfo.getCreateTime().getTime())

    }

```

### 日志

- 添加统一的日志注解（`@Log`），记录请求日志

```

    @ApiOperation(value = "新增警员", httpMethod = "POST")

    @PostMapping("/add")

    @PreAuthorize("hasAnyAuthority('policeInfo:add')")

    @Log(name = "新增警员", module = "警员管理",isSaveLog = true,isSaveRequestData = true)

    public AjaxResult<String> addPoliceInfo(@RequestBody @Valid ReqAddPoliceInfo param) {

        return policeInfoService.addPoliceInfo(param);

    }

```
- 如果请求内容太大（例如上传图像base64），可以重写toSting方法，或者在日志记录时特殊处理
### RESTful API

-使用合适的 HTTP 方法（GET、POST、PUT、DELETE）。
